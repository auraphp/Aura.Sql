<?php
namespace Aura\Sql\Adapter;
use PDO;
use Aura\Sql\AdapterFactory;
use Aura\Sql\ColumnFactory;
use Aura\Sql\Column;

/**
 * Test class for AbstractAdapter.
 * Generated by PHPUnit on 2011-06-21 at 16:49:51.
 */
abstract class AbstractAdapterTest extends \PHPUnit_Framework_TestCase
{
    protected $extension;
    
    protected $dsn = [];
    
    protected $adapter_params = array(
        'dsn'      => [],
        'username' => null,
        'password' => null,
        'options'  => [],
    );
    
    protected $expect_dsn_string;
    
    protected $adapter_type;
    
    protected $adapter;
    
    protected $schema1 = 'aura_test_schema1';
    
    protected $schema2 = 'aura_test_schema2';
    
    protected $table = 'aura_test_table';
    
    protected $create_table;
    
    protected $expect_fetch_table_list;
    
    protected $expect_fetch_table_cols;
    
    protected $expect_quote_scalar;
    
    protected $expect_quote_array;
    
    protected $expect_quote_into;
    
    protected $expect_quote_into_many;
    
    protected $expect_quote_multi;
    
    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    public function setUp()
    {
        parent::setUp();
        
        // skip if we don't have the extension
        if (! extension_loaded($this->extension)) {
            $this->markTestSkipped("Extension '{$this->extension}' not loaded.");
        }
        
        // convert column arrays to objects
        foreach ($this->expect_fetch_table_cols as $name => $info) {
            $this->expect_fetch_table_cols[$name] = new Column(
                $info['name'],
                $info['type'],
                $info['size'],
                $info['scale'],
                $info['notnull'],
                $info['default'],
                $info['autoinc'],
                $info['primary']
            );
        }
        
        // load test config values
        $test_class = get_class($this);
        $this->adapter_params = array_merge(
            $this->adapter_params,
            $GLOBALS[$test_class]['adapter_params']
        );
        
        $this->expect_dsn_string = $GLOBALS[$test_class]['expect_dsn_string'];
        
        $adapter_factory = new AdapterFactory;
        
        $this->adapter = $adapter_factory->newInstance(
            $this->adapter_type,
            $this->adapter_params['dsn'],
            $this->adapter_params['username'],
            $this->adapter_params['password'],
            $this->adapter_params['options']
        );
        
        $this->dropSchemas();
        $this->createSchemas();
        $this->createTables();
        $this->fillTable();
    }
    
    abstract protected function createSchemas();
    
    abstract protected function dropSchemas();
    
    protected function createTables()
    {
        // create in schema 1
        $sql = $this->create_table;
        $this->adapter->query($sql);
        
        // create again in schema 2
        $sql = str_replace($this->table, "{$this->schema2}.{$this->table}", $sql);
        $this->adapter->query($sql);
    }
    
    // only fills in schema 1
    protected function fillTable()
    {
        $names = [
            'Anna', 'Betty', 'Clara', 'Donna', 'Fiona',
            'Gertrude', 'Hanna', 'Ione', 'Julia', 'Kara',
        ];
        
        foreach ($names as $name) {
            $this->adapter->insert($this->table, ['name' => $name]);
        }
    }
    
    public function testGetProfiler()
    {
        $actual = $this->adapter->getProfiler();
        $this->assertInstanceOf('\Aura\Sql\Profiler', $actual);
    }
    
    public function testGetColumnFactory()
    {
        $actual = $this->adapter->getColumnFactory();
        $this->assertInstanceOf('\Aura\Sql\ColumnFactory', $actual);
    }
    
    public function testGetQueryFactory()
    {
        $actual = $this->adapter->getQueryFactory();
        $this->assertInstanceOf('\Aura\Sql\Query\Factory', $actual);
    }
    
    /**
     * @todo Implement testGetDsnString().
     */
    public function testGetDsnString()
    {
        $actual = $this->adapter->getDsnString();
        $this->assertEquals($this->expect_dsn_string, $actual);
    }
    
    /**
     * @todo Implement testConnect().
     */
    public function testGetPdo()
    {
        $actual = $this->adapter->getPdo();
        $this->assertInstanceOf('\PDO', $actual);
    }
    
    public function testQuery()
    {
        $text = "SELECT * FROM {$this->table}";
        $stmt = $this->adapter->query($text);
        $this->assertInstanceOf('PDOStatement', $stmt);
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        $expect = 10;
        $actual = count($result);
        $this->assertEquals($expect, $actual);
    }
    
    public function testQueryWithData()
    {
        $text = "SELECT * FROM {$this->table} WHERE id <= :val";
        $data['val'] = '5';
        $stmt = $this->adapter->query($text, $data);
        $this->assertInstanceOf('PDOStatement', $stmt);
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        $expect = 5;
        $actual = count($result);
        $this->assertEquals($expect, $actual);
    }
    
    public function testQueryWithArrayData()
    {
        $text = "SELECT * FROM {$this->table} WHERE id IN (:list) OR id = :id";
        
        $data['list'] = [1, 2, 3, 4];
        $data['id'] = 5;
        
        $stmt = $this->adapter->query($text, $data);
        $this->assertInstanceOf('PDOStatement', $stmt);
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        $expect = 5;
        $actual = count($result);
        $this->assertEquals($expect, $actual);
    }
    
    public function testQueryWithSelect()
    {
        $select = $this->adapter->newSelect();
        
        $select->cols(['*'])
               ->from($this->table);
        
        $stmt = $this->adapter->query($select);
        
        $this->assertInstanceOf('PDOStatement', $stmt);
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        $expect = 10;
        $actual = count($result);
        $this->assertEquals($expect, $actual);
    }
    
    public function testPrepareWithQuotedStringsAndData()
    {
        $text = "SELECT * FROM {$this->table}
                 WHERE 'leave :foo alone'
                 AND id IN (:list)
                 AND \"leave :bar alone\"";
        
        $data = [
            'list' => [1, 2, 3, 4, 5],
            'foo' => 'WRONG',
            'bar' => 'WRONG',
        ];
        
        $stmt = $this->adapter->prepare($text, $data);
        
        $expect = str_replace(':list', '1, 2, 3, 4, 5', $text);
        $actual = $stmt->queryString;
        $this->assertSame($expect, $actual);
    }
    
    public function testFetchAll()
    {
        $text = "SELECT * FROM {$this->table}";
        $result = $this->adapter->fetchAll($text);
        $expect = 10;
        $actual = count($result);
        $this->assertEquals($expect, $actual);
    }
    
    public function testFetchAssoc()
    {
        $text = "SELECT * FROM {$this->table} ORDER BY id";
        $result = $this->adapter->fetchAssoc($text);
        $expect = 10;
        $actual = count($result);
        $this->assertEquals($expect, $actual);
        
        // // 1-based IDs, not 0-based sequential values
        $expect = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        $actual = array_keys($result);
        $this->assertEquals($expect, $actual);
    }
    
    public function testFetchCol()
    {
        $text = "SELECT id FROM {$this->table} ORDER BY id";
        $result = $this->adapter->fetchCol($text);
        $expect = 10;
        $actual = count($result);
        $this->assertEquals($expect, $actual);
        
        // // 1-based IDs, not 0-based sequential values
        $expect = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
        $this->assertEquals($expect, $result);
    }
    
    public function testFetchValue()
    {
        $text = "SELECT id FROM {$this->table} WHERE id = 1";
        $actual = $this->adapter->fetchValue($text);
        $expect = '1';
        $this->assertEquals($expect, $actual);
    }
    
    public function testFetchPairs()
    {
        $text = "SELECT id, name FROM {$this->table} ORDER BY id";
        $actual = $this->adapter->fetchPairs($text);
        $expect = [
          1  => 'Anna',
          2  => 'Betty',
          3  => 'Clara',
          4  => 'Donna',
          5  => 'Fiona',
          6  => 'Gertrude',
          7  => 'Hanna',
          8  => 'Ione',
          9  => 'Julia',
          10 => 'Kara',
        ];
        $this->assertEquals($expect, $actual);
    }
    
    public function testFetchOne()
    {
        $text = "SELECT id, name FROM {$this->table} WHERE id = 1";
        $actual = $this->adapter->fetchOne($text);
        $expect = [
            'id'   => '1',
            'name' => 'Anna',
        ];
        $this->assertEquals($expect, $actual);
    }
    
    public function testFetchTableList()
    {
        $actual = $this->adapter->fetchTableList();
        $this->assertEquals($this->expect_fetch_table_list, $actual);
    }
    
    public function testFetchTableList_schema()
    {
        $actual = $this->adapter->fetchTableList('aura_test_schema2');
        $this->assertEquals($this->expect_fetch_table_list_schema, $actual);
    }
    
    public function testFetchTableCols()
    {
        $actual = $this->adapter->fetchTableCols($this->table);
        $expect = $this->expect_fetch_table_cols;
        ksort($actual);
        ksort($expect);
        $this->assertSame(count($expect), count($actual));
        foreach (array_keys($expect) as $name) {
            $this->assertEquals($expect[$name], $actual[$name]);
        }
    }
    
    public function testFetchTableCols_schema()
    {
        $actual = $this->adapter->fetchTableCols("aura_test_schema2.{$this->table}");
        $expect = $this->expect_fetch_table_cols;
        ksort($actual);
        ksort($expect);
        $this->assertSame(count($expect), count($actual));
        foreach ($expect as $name => $info) {
            $this->assertEquals($expect[$name], $actual[$name]);
        }
    }
    
    public function testQuote()
    {
        // quote a scalar
        $actual = $this->adapter->quote('"foo" bar \'baz\'');
        $this->assertEquals($this->expect_quote_scalar, $actual);
        
        // quote a number
        $actual = $this->adapter->quote(123.456);
        $this->assertEquals(123.456, $actual);
        
        // quote a numeric
        $actual = $this->adapter->quote('123.456');
        $this->assertEquals(123.456, $actual);
        
        // quote an array
        $actual = $this->adapter->quote(array('"foo"', 'bar', "'baz'"));
        $this->assertEquals($this->expect_quote_array, $actual);
    }
    
    /**
     * @todo Implement testQuoteInto().
     */
    public function testQuoteInto()
    {
        // no placeholders
        $actual = $this->adapter->quoteInto('foo = bar', "'zim'");
        $expect = 'foo = bar';
        $this->assertEquals($expect, $actual);
        
        // one placeholder, one value
        $actual = $this->adapter->quoteInto("foo = ?", "'bar'");
        $this->assertEquals($this->expect_quote_into,$actual);
        
        // many placeholders, many values
        $actual = $this->adapter->quoteInto("foo = ? AND zim = ?", ["'bar'", "'baz'"]);
        $this->assertEquals($this->expect_quote_into_many, $actual);
        
        // many placeholders, too many values
        $actual = $this->adapter->quoteInto("foo = ? AND zim = ?", ["'bar'", "'baz'", "'gir'"]);
        $this->assertEquals($this->expect_quote_into_many, $actual);
    }
    
    /**
     * @todo Implement testQuoteMulti().
     */
    public function testQuoteMulti()
    {
        $where = array(
            'id = 1',
            'foo = ?' => 'bar',
            'zim IN(?)' => array('dib', 'gir', 'baz'),
        );
        $actual = $this->adapter->quoteMulti($where, ' AND ');
        $this->assertEquals($this->expect_quote_multi, $actual);
    }
    
    /**
     * @todo Implement testQuoteName().
     */
    public function testQuoteName()
    {
        // table AS alias
        $actual = $this->adapter->quoteName('table AS alias');
        $this->assertEquals($this->expect_quote_name_table_as_alias, $actual);
        
        // table.col AS alias
        $actual = $this->adapter->quoteName('table.col AS alias');
        $this->assertEquals($this->expect_quote_name_table_col_as_alias, $actual);
        
        // table alias
        $actual = $this->adapter->quoteName('table alias');
        $this->assertEquals($this->expect_quote_name_table_alias, $actual);
        
        // table.col alias
        $actual = $this->adapter->quoteName('table.col alias');
        $this->assertEquals($this->expect_quote_name_table_col_alias, $actual);
        
        // plain old identifier
        $actual = $this->adapter->quoteName('table');
        $this->assertEquals($this->expect_quote_name_plain, $actual);
        
        // star
        $actual = $this->adapter->quoteName('*');
        $this->assertEquals('*', $actual);
        
        // star dot star
        $actual = $this->adapter->quoteName('*.*');
        $this->assertEquals('*.*', $actual);
    }
    
    /**
     * @todo Implement testQuoteNamesIn().
     */
    public function testQuoteNamesIn()
    {
        $sql = "*, *.*, foo.bar, CONCAT('foo.bar', \"baz.dib\") AS zim";
        $actual = $this->adapter->quoteNamesIn($sql);
        $this->assertEquals($this->expect_quote_names_in, $actual);
    }
    
    public function testInsertAndLastInsertId()
    {
        $cols = ['name' => 'Laura'];
        $actual = $this->adapter->insert($this->table, $cols);
        
        // did we get the right last ID?
        $actual = $this->fetchLastInsertId();
        $expect = '11';
        $this->assertEquals($expect, $actual);
        
        // did it insert?
        $actual = $this->adapter->fetchOne("SELECT id, name FROM {$this->table} WHERE id = 11");
        $expect = ['id' => '11', 'name' => 'Laura'];
        $this->assertEquals($actual, $expect);
    }
    
    protected function fetchLastInsertId()
    {
        return $this->adapter->lastInsertId();
    }
    
    public function testUpdate()
    {
        $cols   = ['name' => 'Annabelle'];
        $where  = 'id = :id';
        $data   = ['id' => 1];
        $actual = $this->adapter->update($this->table, $cols, $where, $data);
        
        // did it update?
        $actual = $this->adapter->fetchOne("SELECT id, name FROM {$this->table} WHERE id = 1");
        $expect = ['id' => '1', 'name' => 'Annabelle'];
        $this->assertEquals($actual, $expect);
        
        // did anything else update?
        $actual = $this->adapter->fetchOne("SELECT id, name FROM {$this->table} WHERE id = 2");
        $expect = ['id' => '2', 'name' => 'Betty'];
        $this->assertEquals($actual, $expect);
    }
    
    // public function testUpdateNoBinding()
    // {
    //     $cols   = ['name = 99'];
    //     $where  = 'id = :id';
    //     $data   = ['id' => 1];
    //     $actual = $this->adapter->update($this->table, $cols, $where, $data);
    //     
    //     // did it update?
    //     $actual = $this->adapter->fetchOne("SELECT id, name FROM {$this->table} WHERE id = 1");
    //     $expect = ['id' => '1', 'name' => '99'];
    //     $this->assertEquals($actual, $expect);
    //     
    //     // did anything else update?
    //     $actual = $this->adapter->fetchOne("SELECT id, name FROM {$this->table} WHERE id = 2");
    //     $expect = ['id' => '2', 'name' => 'Betty'];
    //     $this->assertEquals($actual, $expect);
    // }
    
    public function testDelete()
    {
        $where  = 'id = :id';
        $data   = ['id' => 1];
        $actual = $this->adapter->delete($this->table, $where, $data);
        
        // did it delete?
        $actual = $this->adapter->fetchOne("SELECT * FROM {$this->table} WHERE id = 1");
        $this->assertFalse($actual);
        
        // do we still have everything else?
        $actual = $this->adapter->fetchAll("SELECT * FROM {$this->table}");
        $expect = 9;
        $this->assertEquals($expect, count($actual));
    }
    
    public function testTransactions()
    {
        // data
        $cols = ['name' => 'Laura'];

        // begin and rollback
        $this->adapter->beginTransaction();
        $this->adapter->insert($this->table, $cols);
        $actual = $this->adapter->fetchAll("SELECT * FROM {$this->table}");
        $this->assertSame(11, count($actual));
        $this->adapter->rollback();
        $actual = $this->adapter->fetchAll("SELECT * FROM {$this->table}");
        $this->assertSame(10, count($actual));
        
        // begin and commit
        $this->adapter->beginTransaction();
        $this->adapter->insert($this->table, $cols);
        $actual = $this->adapter->fetchAll("SELECT * FROM {$this->table}");
        $this->adapter->commit();
        $this->assertSame(11, count($actual));
    }
}
